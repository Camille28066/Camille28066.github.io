---
layout: default
---

<head>
    <!-- ...existing head content... -->
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markerplayer/dist/leaflet.markerplayer.css"/> <!-- Changed to CDN -->
    
    <meta name="viewport" content="width=device-width,
        initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <script src="https://unpkg.com/leaflet.markerplayer/dist/leaflet.markerplayer.js"></script> <!-- Changed to CDN -->

    <style>
        #shikokuMapContainer { /* Renamed ID for clarity */
            height: 600px; 
            width: 100%;
            position: relative;
        }
        .leaflet-container { font-size: 1rem; }
        /* Styles for custom icons can remain if you plan to use them */
        .custom-icon.plane-icon {
            margin-left: -12px;
            margin-top: -12px;
            width: 24px;
            height: 24px;
        }
    </style>
</head>

<!-- Navigation Tabs -->
<nav style="display: flex; justify-content: flex-end; background: #222; padding: 1.5rem 2rem;">
  <a href="index.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Home</a>
  <a href="resume.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Resume</a>
  <a href="publications.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Publications & Events</a>
  <a href="projects.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Projects</a>
  <a href="labs.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Labs</a>
  <a href="sidestories.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Side Stories</a>
</nav>

<section id="sidestories" style="padding: 2rem; background: #f9f9f9;">
  <h2 style="text-align: center; color: #333; margin-bottom: 2rem;">Side Stories</h2>
  <!-- Content for sidestories page will go here -->
  <p style="text-align: center;">Section japan.</p>
  
  <div id="shikokuMapContainer"></div> <!-- Updated ID -->

</section>

<script>
    var shikokuMap = L.map('shikokuMapContainer', { // Use updated ID
        zoomControl: true,
        preferCanvas: false,
    });

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(shikokuMap);

    var gpxTrackFile = 'shikoku_track.gpx';
    var gpxLayer = new L.GPX(gpxTrackFile, {
        async: true,
        marker_options: { 
            startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-start.png',
            endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-end.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png',
            wptIconUrls: { '': 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-wpt.png' }
        },
        polyline_options: { 
            color: 'rgba(0, 0, 255, 0.3)', 
            opacity: 0.3,
            weight: 3,
            lineCap: 'round'
        }
    }).on('loaded', function(e) {
        shikokuMap.fitBounds(e.target.getBounds());

        var rawCoordinates = []; // [[lng, lat], ...]
        function processLatLngs(latlngsArray) {
            if (latlngsArray && latlngsArray.length > 0) {
                if (Array.isArray(latlngsArray[0]) && latlngsArray[0][0] instanceof L.LatLng) {
                    latlngsArray.forEach(function(segment) {
                        segment.forEach(function(latlng) {
                            rawCoordinates.push([latlng.lng, latlng.lat]);
                        });
                    });
                } else if (latlngsArray[0] instanceof L.LatLng) {
                    latlngsArray.forEach(function(latlng) {
                        rawCoordinates.push([latlng.lng, latlng.lat]);
                    });
                }
            }
        }

        e.target.eachLayer(function(layer) {
            if (layer instanceof L.Polyline) {
                processLatLngs(layer.getLatLngs());
            }
        });

        console.log("Raw coordinates extracted:", rawCoordinates.length);
        if (rawCoordinates.length <= 1) {
            console.warn("Not enough coordinates to animate. GPX points found:", rawCoordinates.length);
            return; 
        }

        // Prepare points for L.markerPlayer: array of [lat, lng]
        var playerPoints = rawCoordinates.map(function(coord) {
            return [coord[1], coord[0]]; // Convert [lng, lat] to [lat, lng]
        });

        var pointIntervalMs = 500; // Duration in ms for each segment
        var playerDurations = [];
        for (var i = 0; i < playerPoints.length - 1; i++) {
            playerDurations.push(pointIntervalMs);
        }
        
        if (playerPoints.length > 0 && playerDurations.length === 0 && playerPoints.length === 1) {
            // Handle single point case for duration if MarkerPlayer requires it
            // Though typically animation needs at least two points.
            // If MarkerPlayer supports a single point with a total duration, adjust here.
            // For now, assuming animation implies >1 point.
        } else if (playerPoints.length > 1 && playerDurations.length === 0) {
            // This case should not happen if pointIntervalMs is used correctly for multiple points
            console.warn("Player durations array is empty for multiple points. This might be an error.");
            // Fallback: calculate total duration and let MarkerPlayer distribute it
            // var totalDuration = (playerPoints.length -1) * pointIntervalMs;
            // playerDurations = totalDuration; // This would make it a single number for total duration
        }

        console.log("Points for MarkerPlayer:", playerPoints.length, "Durations per segment:", playerDurations.length);

        if (playerPoints.length < 2) {
            console.warn("MarkerPlayer requires at least two points to animate a path.");
            return;
        }

        var markerPlayer = L.markerPlayer(playerPoints, playerDurations, {
            autostart: true, // Changed from playOnLoad
            loop: true,
            // Example of using a Leaflet.AwesomeMarkers icon for the player
            // icon: L.AwesomeMarkers.icon({icon: 'bicycle', markerColor: 'red', prefix: 'fa'}) 
        }).addTo(shikokuMap);

        markerPlayer.on('play', function() { console.log('MarkerPlayer: playing'); });
        markerPlayer.on('pause', function() { console.log('MarkerPlayer: paused'); });
        markerPlayer.on('end', function() { console.log('MarkerPlayer: ended'); });
        
        // Optional: remove the static GPX track if you only want the animation
        // shikokuMap.removeLayer(gpxLayer);

    }).on('error', function(e) {
        console.error("Error loading GPX file: ", e.err, e);
    }).addTo(shikokuMap);

</script>
