---
layout: default
---

<head>
    <!-- ...existing head content... -->
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.control.css"/>
    
    <meta name="viewport" content="width=device-width,
        initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

    <style>
        #shikokuTimeDimensionMap {
            height: 600px; /* You can adjust the height */
            width: 100%;
            position: relative;
        }
        .leaflet-container { font-size: 1rem; } /* From shikoku_track_ref.html */
    </style>
</head>

<!-- Navigation Tabs -->
<nav style="display: flex; justify-content: flex-end; background: #222; padding: 1.5rem 2rem;">
  <a href="index.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Home</a>
  <a href="resume.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Resume</a>
  <a href="publications.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Publications & Events</a>
  <a href="projects.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Projects</a>
  <a href="labs.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Labs</a>
  <a href="sidestories.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Side Stories</a>
</nav>

<section id="sidestories" style="padding: 2rem; background: #f9f9f9;">
  <h2 style="text-align: center; color: #333; margin-bottom: 2rem;">Side Stories</h2>
  <!-- Content for sidestories page will go here -->
  <p style="text-align: center;">Section japan.</p>
  
  <div id="shikokuTimeDimensionMap"></div>

</section>

<script>
    // Ensure this script runs after the DOM is fully loaded
    // Initialize the map
    var shikokuMap = L.map('shikokuTimeDimensionMap', {
        zoomControl: true,
        preferCanvas: false,
    });

    // Add Esri World Imagery tile layer
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(shikokuMap);

    // TimeDimension plugin setup
    L.Control.TimeDimensionCustom = L.Control.TimeDimension.extend({});

    shikokuMap.timeDimension = L.timeDimension({
        // period: Will be set by setAvailableTimes or by the layer
    });

    var desiredAnimationDurationSeconds = 60;
    var desiredFps = 30;
    var numAnimationFrames = desiredAnimationDurationSeconds * desiredFps;
    var playerTransitionTimeMs = Math.round(1000 / desiredFps); // e.g., 33ms for 30fps

    var timeDimensionControl = new L.Control.TimeDimensionCustom({
        playerOptions: {
            loop: true,
            startOver: true,
            transitionTime: playerTransitionTimeMs,
        },
        position: 'bottomleft'
    });
    shikokuMap.addControl(timeDimensionControl);

    var gpxTrackFile = 'shikoku_track.gpx';
    var gpxLayer = new L.GPX(gpxTrackFile, {
        async: true,
        marker_options: {
            startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-start.png',
            endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-end.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png',
            wptIconUrls: { '': 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-wpt.png' }
        },
        polyline_options: {
            color: 'rgba(0, 0, 255, 0.3)',
            opacity: 0.3,
            weight: 3,
            lineCap: 'round'
        }
    }).on('loaded', function(e) {
        shikokuMap.fitBounds(e.target.getBounds());

        var coordinates = [];
        // Define processLatLngs to correctly populate coordinates
        function processLatLngs(latlngsArray) {
            if (latlngsArray && latlngsArray.length > 0) {
                if (Array.isArray(latlngsArray[0]) && latlngsArray[0][0] instanceof L.LatLng) { // Array of arrays of LatLngs (MultiPolyline)
                    latlngsArray.forEach(function(segment) {
                        segment.forEach(function(latlng) {
                            coordinates.push([latlng.lng, latlng.lat]);
                        });
                    });
                } else if (latlngsArray[0] instanceof L.LatLng) { // Array of LatLngs (Polyline)
                    latlngsArray.forEach(function(latlng) {
                        coordinates.push([latlng.lng, latlng.lat]);
                    });
                }
            }
        }

        e.target.eachLayer(function(layer) {
            if (layer instanceof L.Polyline) {
                processLatLngs(layer.getLatLngs());
            }
        });

        console.log("Coordinates extracted:", coordinates.length);
        if (coordinates.length <= 1) {
            console.warn("Not enough coordinates to animate. GPX points found:", coordinates.length);
            return;
        }

        var baseTimeForGeoJson = new Date(Date.UTC(2023, 0, 1, 0, 0, 0));
        var timestampsInGeoJson = [];
        for (var i = 0; i < coordinates.length; i++) {
            var pointTime = new Date(baseTimeForGeoJson.getTime() + i * 500); // 0.5 second interval for data points
            timestampsInGeoJson.push(pointTime.toISOString());
        }

        var geoJsonData = {
            type: "Feature",
            geometry: { type: "LineString", coordinates: coordinates },
            properties: {
                times: timestampsInGeoJson, // Crucial for L.timeDimension.layer.geoJson
                style: { // Style for the animated track
                    color: 'rgba(255, 0, 0, 0.8)', // Red, more opaque
                    weight: 5
                }
            }
        };
        
        var baseGeoJsonLayer = L.geoJson(geoJsonData, {
            style: function (feature) { return feature.properties.style; }
        });

        var animatedLayer = L.timeDimension.layer.geoJson(baseGeoJsonLayer, {
            updateTimeDimension: true,
            addlastPoint: true, // Show a marker at the current time position
            updateTimeDimensionMode: 'update',
        });
        animatedLayer.addTo(shikokuMap);
        
        var totalOriginalDataDurationMs = (coordinates.length - 1) * 500;
        var timeIncrementPerFrameMs = 0;
        if (numAnimationFrames > 1) {
            timeIncrementPerFrameMs = totalOriginalDataDurationMs / (numAnimationFrames - 1);
        } else if (numAnimationFrames === 1) {
            timeIncrementPerFrameMs = totalOriginalDataDurationMs; // Single frame shows the end state
        }

        console.log("Total original data duration (ms) based on 0.5s interval:", totalOriginalDataDurationMs);
        console.log("Time increment per frame (ms):", timeIncrementPerFrameMs);
        console.log("Number of animation frames desired:", numAnimationFrames);

        var timestampsForControl = [];
        if (numAnimationFrames > 0) {
            for (var k = 0; k < numAnimationFrames; k++) { // Use k to avoid conflict with outer i
                var frameTimeMs = baseTimeForGeoJson.getTime() + k * timeIncrementPerFrameMs;
                timestampsForControl.push(new Date(frameTimeMs).toISOString());
            }
            // Ensure the last frame timestamp corresponds to the total duration if multiple frames
            if (numAnimationFrames > 1 && timestampsForControl.length > 0) {
                timestampsForControl[timestampsForControl.length - 1] = new Date(baseTimeForGeoJson.getTime() + totalOriginalDataDurationMs).toISOString();
            }
            
            console.log("Timestamps for control: count=", timestampsForControl.length, "sample:", timestampsForControl.slice(0,5));

            if (timestampsForControl.length > 0) {
                shikokuMap.timeDimension.setAvailableTimes(timestampsForControl, 'replaceAll');
                // Optional: Adjust period if needed, though setAvailableTimes usually suffices
                // var mapPeriodSeconds = Math.max(1, Math.round(timeIncrementPerFrameMs / 1000));
                // shikokuMap.timeDimension.options.period = "PT" + mapPeriodSeconds + "S";
                // console.log("Set map timeDimension period to PT" + mapPeriodSeconds + "S");
            } else {
                console.warn("No timestamps generated for the time dimension control (numAnimationFrames > 0 but timestampsForControl is empty).");
            }
        } else {
            console.warn("numAnimationFrames is 0, cannot generate timestamps for control.");
        }
    }).on('error', function(e) {
        console.error("Error loading GPX file: ", e.err, e);
    }).addTo(shikokuMap);

</script>
