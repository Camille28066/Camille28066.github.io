---
layout: default
---

<head>
    <!-- ...existing head content... -->
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.control.css"/>
    
    <meta name="viewport" content="width=device-width,
        initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script> <!-- Added leaflet-gpx library -->

    <style>
        #shikokuTimeDimensionMap {
            height: 600px; /* You can adjust the height */
            width: 100%;
            position: relative;
        }
        .leaflet-container { font-size: 1rem; } /* From shikoku_track_ref.html */
    </style>
</head>

<!-- Navigation Tabs -->
<nav style="display: flex; justify-content: flex-end; background: #222; padding: 1.5rem 2rem;">
  <a href="index.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Home</a>
  <a href="resume.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Resume</a>
  <a href="publications.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Publications & Events</a>
  <a href="projects.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Projects</a>
  <a href="labs.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Labs</a>
  <a href="sidestories.html" style="color: #fff; text-decoration: none; margin-left: 1.5rem; font-weight: bold;">Side Stories</a>
</nav>

<section id="sidestories" style="padding: 2rem; background: #f9f9f9;">
  <h2 style="text-align: center; color: #333; margin-bottom: 2rem;">Side Stories</h2>
  <!-- Content for sidestories page will go here -->
  <p style="text-align: center;">Section japan.</p>
  
  <div id="shikokuTimeDimensionMap"></div>

</section>

<script>
    // Ensure this script runs after the DOM is fully loaded,
    // or place it at the end of the body if jQuery's $(document).ready is not used.
    // Since jQuery is loaded, we can use it, or simply ensure script order.

    // Initialize the map
    var shikokuMap = L.map('shikokuTimeDimensionMap', {
        // center: [33.8, 133.5], // Will be set by gpx load
        // zoom: 7, // Will be set by gpx load
        zoomControl: true,
        preferCanvas: false,
    });

    // Add Esri World Imagery tile layer
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(shikokuMap);

    // TimeDimension plugin setup
    L.Control.TimeDimensionCustom = L.Control.TimeDimension.extend({
        // Add any custom options or methods here
    });

    shikokuMap.timeDimension = L.timeDimension({
        period: "PT1S", // Each point/segment will be shown for 1 second
        // currentTime: new Date(Date.UTC(2023, 0, 1, 0, 0, 0)) // Set a start time
    });

    var timeDimensionControl = new L.Control.TimeDimensionCustom({
        playerOptions: {
            loop: true,
            startOver: true,
            transitionTime: 50, // milliseconds, as in folium_japan.py
            // minSpeed: 1, // Adjust as needed
            // maxSpeed: 10 // Adjust as needed
        },
        position: 'bottomleft'
    });
    shikokuMap.addControl(timeDimensionControl);

    // Load GPX track, extract coordinates, and create animated layer
    var gpxTrackFile = 'track.gpx'; // Path to your GPX file
    var gpxLayer = new L.GPX(gpxTrackFile, {
        async: true,
        marker_options: {
            startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-start.png',
            endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-end.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png',
            wptIconUrls: {
                '': 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-wpt.png',
            }
        },
        polyline_options: {
            color: 'rgba(0, 0, 255, 0.3)', // Static track less prominent
            opacity: 0.3,
            weight: 3,
            lineCap: 'round'
        }
    }).on('loaded', function(e) {
        shikokuMap.fitBounds(e.target.getBounds());

        var coordinates = [];
        // Correctly extract coordinates from all polylines in the GPX
        e.target.eachLayer(function(layer) {
            if (layer instanceof L.Polyline) {
                var latLngs = layer.getLatLngs();
                // Handle both simple polylines and multi-polylines (though track.gpx is simple)
                function processLatLngs(arr) {
                    arr.forEach(function(latLng) {
                        if (latLng instanceof L.LatLng) {
                            coordinates.push([latLng.lng, latLng.lat]); // GeoJSON format: [lon, lat]
                        } else if (Array.isArray(latLng)) { // For nested arrays in multi-polylines
                            processLatLngs(latLng);
                        }
                    });
                }
                processLatLngs(latLngs);
            }
        });

        if (coordinates.length > 0) {
            var startTime = new Date(Date.UTC(2023, 0, 1, 0, 0, 0)); // Arbitrary start time
            var timestamps = [];
            for (var i = 0; i < coordinates.length; i++) {
                var pointTime = new Date(startTime.getTime() + i * 1000); // 1 second interval
                timestamps.push(pointTime.toISOString());
            }

            var geoJsonData = {
                type: "Feature",
                geometry: {
                    type: "LineString",
                    coordinates: coordinates
                },
                properties: {
                    times: timestamps,
                    style: { color: "#FF4500", weight: 3 } // Style for the animated line
                }
            };
            
            // Create a GeoJSON layer with the extracted data and style
            var baseGeoJsonLayer = L.geoJson(geoJsonData, {
                style: function (feature) {
                    return feature.properties.style;
                }
            });

            var animatedLayer = L.timeDimension.layer.geoJson(baseGeoJsonLayer, {
                updateTimeDimension: true,
                addlastPoint: false, // Set to false to animate line segments
                updateTimeDimensionMode: 'replace' // Folium typically uses 'replace'
            });
            animatedLayer.addTo(shikokuMap);
            
            if (timestamps.length > 0) {
                shikokuMap.timeDimension.setAvailableTimes(timestamps, 'replace');
                // Optionally, set current time to the beginning of the track
                // shikokuMap.timeDimension.setCurrentTime(new Date(timestamps[0]).getTime());
            }
        } else {
            console.warn("No coordinates found in GPX to animate.");
        }
    }).on('error', function(e) {
        console.error("Error loading GPX file: ", e.err);
    }).addTo(shikokuMap); // Adds the static GPX layer to the map

    // Note: The static GPX track (from new L.GPX(...)) is added to the map.
    // The animated GeoJSON layer will be drawn on top.
    // The animation will be very short with only 8 points from track.gpx.

</script>
